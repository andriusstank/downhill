
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Andrius Stankevičius" name="author"/>
<link href="http://localhost:8000/intro/part1/" rel="canonical"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.2.3, mkdocs-material-7.3.5" name="generator"/>
<title>Gradient Type - Downhill</title>
<link href="../../assets/stylesheets/main.cdeb8541.min.css" rel="stylesheet"/>
<link href="../../assets/stylesheets/palette.3f5d1f46.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
<link href="../../js/style.css" rel="stylesheet"/>
</head>
<body data-md-color-accent="none" data-md-color-primary="none" data-md-color-scheme="" dir="ltr">
<script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#on-the-type-of-the-gradient">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="Downhill" class="md-header__button md-logo" data-md-component="logo" href="../.." title="Downhill">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Downhill
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Gradient Type
            
          </span>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/andriusstank/downhill/" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Downhill" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="Downhill">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"></path></svg>
</a>
    Downhill
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/andriusstank/downhill/" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
        Home
      </a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2">
          Design
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Design" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
          Design
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" data-md-toggle="toc" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
          Gradient Type
          <span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
        Gradient Type
      </a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#dimensional-analysis">
    Dimensional analysis
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#superficial-hilbert-space">
    Superficial Hilbert space
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#gradient-descent">
    Gradient descent
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../part2/">
        Linear Graph
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../part3/">
        Sparsity
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../getstart/">
        Get Started
      </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#dimensional-analysis">
    Dimensional analysis
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#superficial-hilbert-space">
    Superficial Hilbert space
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#gradient-descent">
    Gradient descent
  </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<a class="md-content__button md-icon" href="https://github.com/andriusstank/downhill/edit/master/docs/intro/part1.md" title="Edit this page">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"></path></svg>
</a>
<h1 id="on-the-type-of-the-gradient">On the type of the gradient</h1>
<p>We focus on differentiating a scalar valued function <code>f :: V -&gt; R</code>,
where <code>V</code> is a vector space over real numbers <code>R</code>.</p>
<p>Reverse mode automatic differentiation computes gradients
for all intermediate variables. The gradient is usually given
the same type as the variable itself. This is obvious thing to do
when you see all variables as numbers or arrays of numbers.
Yet we can do better by making good use of the type system.</p>
<p>Mixing variables and gradients generally makes no sense.
Code is more readable and easier to write if we give them
different types.
As we flip the edges of computational graph, variables
and gradients kind of swap roles. That would be incredibly confusing
if compiler didn’t help tracking which is which.</p>
<h2 id="dimensional-analysis">Dimensional analysis</h2>
<p>Units make a great example of why we might want to keep distinction
between variables and their gradients. Take an expression to compute
mass ratio of a rocket as example:</p>
<pre><code class="language-haskell">dry, fuel :: Kg
ratio = (dry+fuel) / dry :: R
</code></pre>
<p>Here <code>dry</code> is the mass of empty rocket, <code>fuel</code> is the mass of the fuel,
both measured in kilograms. Mass ratio, as well as its gradient, are
dimensionless real numbers.
It was intentionally chosen so, in order to avoid circular reasoning.
Let’s compute gradients of <code>dry</code> and <code>fuel</code>, starting backpropagation
from <code>ratio</code>:</p>
<pre><code class="language-haskell">d_ratio = 1 :: R
d_fuel = 1/dry :: Kg^(-1)
d_dry = -fuel/dry^2 :: Kg^(-1)
</code></pre>
<p>See? Variables have units of <span class="arithmatex">\(\mathrm{kg}\)</span>, while their gradients
are measured in <span class="arithmatex">\(\frac{1}{\mathrm{kg}}\)</span>. That’s because variables are
<em>contravariant</em> vectors, while gradients are <em>covariant</em> vectors.
Their units are inverse of each other.</p>
<h2 id="superficial-hilbert-space">Superficial Hilbert space</h2>
<p>Use of the same type <code>V</code> for both variables gradients is
typically justified by Riesz representation theorem.</p>
<p>Gradient of a variable <code>x :: V</code> is fundamentally a
linear function of type <code>V -&gt; R</code>. Of course, such a representation is
unworkable – we need to store gradients as numbers and actually compute sums
during reverse accumulation. Otherwise we will run into combinatorial
explosion of repeated computations.</p>
<p>Now if <code>V</code> happens to be Hilbert space, then <code>V -&gt; R</code> is isomorphic to <code>V</code>.
For our purposes Hilbert space requirement boils down
to existance of a well behaved inner product
<code>(&lt;.&gt;) :: V -&gt; V -&gt; R</code>.
Seems to be a benign requirement – any finite
dimensional vector space over real numbers can be equipped with one.</p>
<p>We have a solid theory behind using <code>V</code> type for gradients. Nonetheless,
we saw units don’t match. How come?</p>
<p>Turns out we can’t take inner product for granted. Record with variety of
units shows this clearly:</p>
<pre><code class="language-haskell">data Rocket = Rocket
  { rocketMass :: Kg
  , rocketVelocity :: Meter/Second
  }

-- InnerSpace comes from vector-space package.
instance InnerSpace Rocket where
  Rocket m1 v1 &lt;.&gt; Rocket m2 v2 = (m1 &lt;.&gt; m2) ^+^ (v1 &lt;.&gt; v2)
</code></pre>
<p>We are adding <span class="arithmatex">\(\frac{m^2}{s^2}\)</span> to <span class="arithmatex">\(\mathrm{kg}^2\)</span> and expecting to get a
dimensionless scalar! Although it is possible to provide an <code>InnerSpace Rocket</code>
instance – all we need to do
is to drop units – but we’d very much rather not to. Isomorphism grounded on
such an instance is akin to isomorphism between kilograms and meters – it does
indeed exist, but we wouldn’t want to invoke it automatically.</p>
<h2 id="gradient-descent">Gradient descent</h2>
<p>Having established the rule of no mixing of variables and gradients, we
see that gradient descent is in outright violation of this rule:
$$
\mathbf{a}_{n+1} = \mathbf{a}_n-\gamma\nabla F(\mathbf{a}_n)
$$</p>
<p>We need a <em>metric tensor</em> to relate gradients and variables here.
It’s logical when you think about it – gradient descent moves in the
direction of the steepest
descent. Ability to measure distances is needed to make any sense
of steepness.</p>
<p>Metric tensor brings different units into commensurable quantities.
It also plays the role of preconditioner. Therefore, we opt to
passing metric tensor explicitly instead of demanding existance
of canonical one via Hilber space.</p>
<!--
Sometimes there is 
There are infinitely many choices of metric tensor. 
Demanding `V` to be
a Hilbert space means choosing a canonical one. Instead, we opt to
passing metric tensor explicitly where needed. Importantly,
differentiation does not need one.
-->
</article>
</div>
</div>
</main>
<footer class="md-footer">
<nav aria-label="Footer" class="md-footer__inner md-grid">
<a aria-label="Previous: Home" class="md-footer__link md-footer__link--prev" href="../.." rel="prev">
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</div>
<div class="md-footer__title">
<div class="md-ellipsis">
<span class="md-footer__direction">
                Previous
              </span>
              Home
            </div>
</div>
</a>
<a aria-label="Next: Linear Graph" class="md-footer__link md-footer__link--next" href="../part2/" rel="next">
<div class="md-footer__title">
<div class="md-ellipsis">
<span class="md-footer__direction">
                Next
              </span>
              Linear Graph
            </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
<div class="md-footer-copyright__highlight">
            © 2021 Andrius Stankevičius
          </div>
        
        
          Made with
          <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
            Material for MkDocs
          </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.8397ff9e.min.js", "version": null}</script>
<script src="../../assets/javascripts/bundle.1e84347e.min.js"></script>
<script src="../../js/mathjax.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</body>
</html>